{"ts":1371139771721,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"/* Abrir arquivos xml, montar objetos e salva-los */\nvar fs = require('fs'),\n    xml2js = require('xml2js');\n\nvar parser = new xml2js.Parser();\nvar open = function (file, cb) {\n    fs.readFile(__dirname + file, function(err, xml) {\n        parser.parseString(xml, function (err, json) {\n            cb(json);\n        });\n    });\n}\n\n\nopen('/pessoas.xml', function (persons) {\n    var handled = 0;\n\n    for (var i in persons.Persons.Person) {\n        var Person = require('./person'),\n        \tperson = new Person ({\n                uri:persons.Persons.Person[i].$.uri.replace(\"http://www.ic.unicamp.br/MC536/2013/1/\",\"\"),\n                name:persons.Persons.Person[i].$.name,\n                hometown:persons.Persons.Person[i].$.hometown\n            });\n        person.save(function () {\n            handled++;\n            if(handled >= persons.Persons.Person.length){\n                CreateKnows();\n                CreateMovies();\n                CreateBands(mergeBands);\n            }\n        });\n    }\n});\n\nfunction CreateMovies(){\n    var createMovie = function (movie_name, person, rating) {\n        require('./movie').find(\n            movie_name,\n            function (movie) {\n                movie.save(function(){\n                    var Like = require('./like'),\n                        like = new Like({\n                            person : person,\n                            culturalAct : movie.name,\n                            rating : rating\n                        });\n                    like.save()\n                });\n            }\n        );\n    };\n\n    open('/CurteFilme.xml', function (likesMovies) {\n        for (var i in likesMovies.AllLikesMovie.LikesMovie) {\n        \tcreateMovie(\n                likesMovies.AllLikesMovie.LikesMovie[i].$.movieUri.replace(\"http://www.imdb.com/title/\", \"\").replace(\"/\", \"\"),\n                likesMovies.AllLikesMovie.LikesMovie[i].$.person.replace(\"http://www.ic.unicamp.br/MC536/2013/1/\",\"\"),\n                likesMovies.AllLikesMovie.LikesMovie[i].$.rating\n            );\n        }\n    });\n}\n\nfunction CreateBands(cb){\n\n    var createBand = function (band_name, person, rating, cb) {\n        require('./band').find(\n            band_name,\n            function (band) {\n                band.save(function(){\n                    var Like = require('./like'),\n                        like = new Like({\n                            person : person,\n                            culturalAct : band_name,\n                            rating : rating\n                        });\n                    like.save(cb);\n                });\n            }\n        );\n    };\n\n    open('/CurteMusica.xml', function (likesMusic) {\n        var handled = 0;\n\n        for (var i in likesMusic.AllLikesMusic.LikesMusic) {\n            var musicUri = likesMusic.AllLikesMusic.LikesMusic[i].$.bandUri.replace(\"http://en.wikipedia.org/wiki/\", \"\");\n            musicUri = musicUri.replace('%28', '(');\n            musicUri = musicUri.replace('%29', ')');\n            musicUri = musicUri.replace(/_/g, ' ');\n            musicUri = musicUri.replace(/[\\s\\(]+[(A-Za-z\\s)*]+[\\)]/, \"\");\n            musicUri = musicUri.replace(\"band\", \"\");\n            createBand(\n                musicUri,\n                likesMusic.AllLikesMusic.LikesMusic[i].$.person.replace(\"http://www.ic.unicamp.br/MC536/2013/1/\",\"\"),\n                likesMusic.AllLikesMusic.LikesMusic[i].$.rating,\n                function(){\n                    handled++;\n                    if(handled >= likesMusic.AllLikesMusic.LikesMusic.length) {\n                        cb()\n                    }\n                }\n            );            \n        }\n    });\n}\n\n\nfunction mergeBand (musicName) {\n    require('./get')(\"http://musicbrainz.org/ws/2/artist?limit=1&fmt=json&query=\"+musicName, function (music) {\n        if(music && music.artist && music.artist[0] && music.artist[0].country) {\n            require('./country').find(music.artist[0].country, function(country){\n                if(country){\n                    country.save(function(){\n                        require('./db')(\n                            'UPDATE band SET location = \"' + country.name + '\" WHERE name = \"' + musicName + '\"',\n                            {},\n                            function(){\n\n                            }\n                        );\n\n                    });\n                }\n            },\n            \"&country=\"\n            );\n            \n        }\n        else console.log(\"Ato musical sem pais:\" +musicName);\n    });\n}\n\nfunction mergeBands () {\n    require('./db')('SELECT name FROM band WHERE location IS NULL and name > \"R\"', {}, function (err, bands) {\n        var i = 0;\n        setInterval(function () {\n            if(i < bands.length) {\n                mergeBand(bands[i].name)\n                i++;\n            }\n        }, 1000);\n    });\n}\n\n\nfunction CreateKnows() {\n    open('/Conhece.xml', function (knows) {\n        for (var i in knows.AllKnows.Knows) {\n            var Know = require('./know'),\n                know = new Know({\n                    person : knows.AllKnows.Knows[i].$.person.replace(\"http://www.ic.unicamp.br/MC536/2013/1/\",\"\"),\n                    colleague : knows.AllKnows.Knows[i].$.colleague.replace(\"http://www.ic.unicamp.br/MC536/2013/1/\",\"\")\n                });\n            know.save();\n        }\n    });\n}"]],"start1":0,"start2":0,"length1":0,"length2":5340}]],"length":5340}
